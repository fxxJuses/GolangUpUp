# CAP 理论

![image-20230330211350164](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230330211350164.png)

分布式架构中，CA是不可能成立的，因为P的存在。

单机架构中，CA是可以实现的。



## Base理论

在CAP理论下进行妥协，

![image-20230330211819513](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230330211819513.png)

服务降级： 服务是有特别重要、重要、不重要的划分，当访问量特别大的时候，可能会采用服务降级，将不重要的服务响应延长，然后优先响应特别重要的服务。从而抗住高访问量。



## 数据一致性模型有哪些？





## 分布式缓存

高并发场景下，有两种具体的场景。

- 高并发但是没有海量的数据需要缓存。
- 高并发但是有海量的数据需要缓存。

针对上述两个具体的场景有以下的解决方案。

#### 针对高并发但是没有海量数据存储要求的情况：

采用Redis 的主从模式，加上读写分离的方式，缓解高并发的读写需求。

主Redis负责写，当数据向redis中写时，需要先向主Redis中写，然后主Redis向 从redis中同步数据。

从Redis 负责读，当数据需要读的时候，会向 从Redis中去读取数据。

【这里貌似会有一个主从数据一致性的问题】



#### 针对高并发但是有海量数据存储要求的情况：

Redis的主从复制模式，不能够存储海量的数据，因为每个Redis中的数据都是一样的，所以对于海量场景而言，主从模式并不能缓解海量数据存储的问题。

这里需要采用Redis的切片模式，即将数据分别放入到不同的Redis服务器中，从而分布式的存储这些数据。

具体实现方法是采用的 哈希一致性算法 - >>> hash(ip + 编号) % 2^32

![image-20230330223730729](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230330223730729.png)

具体的可以将所有数据的分布想象成一个环状的数据结构，当数据需要写入的时候或者读出的时候，会计算一个hash值，然后根据这个hash去正向的寻找Redis服务器所在的hash位置，然后对该Redis进行操作。

这种方案：

- ​	能够存储海量的数据
- ​    在服务器出现消失或者插入的时候，只需要对两个Redis进行数据复制即可，避免了泛洪的问题

但是哈希一致性算法也有自己的缺点，就是由于hash的分配是近似于随机的分配，所以会导致数据倾斜问题。

【数据倾斜问题：大量的数据放在少量的服务器中，少量的数据放在大量的服务器中】

为了解决这种问题，可以通过向环中插入N个虚拟的Redis服务器，使得数据存储尽可能的均分的存储在不同的redis服务器中，但本质上redis服务器的数量并没有增加。



## 缓存击穿

![image-20230330232256838](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230330232256838.png)

布隆过滤器，通过错误率去换取空间。

原本可以采用将所有的id都存到一个过滤器中，但这种方法随着数据的增多，过滤器就会占用大量的内存，并且查询效率也低，对于正常用户而言，影响了他们的体验。

所以使用布隆过滤器可以通过错误率去换取空间，具体实现方式是，开启一个范围较小的hash表，然后每个位置是二进制的表达方式，0代表没有，1代表有数据。**如果查询id进来查询，先经过hash函数计算，并且hash值是在一个固定的范围中，如果查询到为1，那么这个数据不一定会存在。但是！！！如果查询到为0，那这个数据一定不存在！！！**

hash碰撞概率大，可以通过多次hash，然后去判断多个位置的hash位置是否都是1，错误率就是1/10^n



# 从单体到分布式微服务

### 单体的问题

- 可靠性问题 ， 容易挂！单点故障 ---》 LVS 4层，基于流量 基于数据包![image-20230331000652033](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230331000652033.png)

![image-20230331001114908](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230331001114908.png)

LVS 4层是TCP协议

Nginx 是7层的 是HTTP协议

![image-20230331003402523](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230331003402523.png)

反向代理后 负载均衡

Nginx 负载均衡

![image-20230331103653220](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230331103653220.png)

![image-20230331104324295](C:\Users\14583\AppData\Roaming\Typora\typora-user-images\image-20230331104324295.png)

### 分布式锁

tradoff

redlock

